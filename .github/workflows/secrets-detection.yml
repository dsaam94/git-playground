name: Secrets Detection
run-name: Scanning for exposed secrets and credentials 🔍

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'

jobs:

  gitleaks:
    name: Gitleaks Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
         # GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE}}

  detect-secrets:
    name: Detect Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Run detect-secrets
        run: |
          detect-secrets scan --all-files --baseline .secrets.baseline || true
          detect-secrets audit .secrets.baseline || true

      - name: Upload secrets baseline
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secrets-baseline
          path: .secrets.baseline

  secrets-summary:
    name: Secrets Detection Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, detect-secrets]
    if: always()
    steps:
      - name: Create secrets summary
        run: |
          echo "## 🔍 Secrets Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Gitleaks | ${{ needs.gitleaks.result }} | Detect and prevent secrets in git repos |" >> $GITHUB_STEP_SUMMARY
          echo "| Detect-Secrets | ${{ needs.detect-secrets.result }} | Enterprise-ready secrets detection |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🚨 Security Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- Review any flagged secrets immediately" >> $GITHUB_STEP_SUMMARY
          echo "- Rotate compromised credentials" >> $GITHUB_STEP_SUMMARY
          echo "- Use GitHub Secrets for sensitive data" >> $GITHUB_STEP_SUMMARY
          echo "- Enable branch protection rules" >> $GITHUB_STEP_SUMMARY
